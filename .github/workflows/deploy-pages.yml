# Deploy to GitHub Pages (single-file solution)
# Commit this file to your main branch. It copies tracked static site files,
# rewrites leading-root references like "/styles.css" -> "styles.css",
# injects a <base href="..."> appropriate for project vs user pages,
# and publishes the result to the gh-pages branch.
#
# Works without adding other files to the repo (it writes a small helper
# script at runtime).

name: Deploy to GitHub Pages (repo-safe single-file)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (for helper script)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Compute BASE_HREF for Pages
        id: base
        run: |
          REPO="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          if [ "$REPO" = "${OWNER}.github.io" ]; then
            echo "BASE_HREF=/" >> $GITHUB_ENV
          else
            # project pages served at /<repo>/
            echo "BASE_HREF=/${REPO}/" >> $GITHUB_ENV
          fi
          echo "BASE_HREF=${BASE_HREF:-${REPO}}" # log

      - name: Prepare publish directory (copy tracked site files)
        run: |
          rm -rf public
          mkdir -p public
          # Copy HTML/CSS/JS plus data/ and assets/ (tracked files only)
          git ls-files | \
            grep -E '\.html$|\.css$|\.js$|^data/|^assets/' || true | \
            while IFS= read -r f; do
              [ -z "$f" ] && continue
              mkdir -p "public/$(dirname "$f")"
              cp -p "$f" "public/$f"
            done

      - name: Write helper script (inject & fix root references)
        run: |
          mkdir -p .github/scripts
          cat > .github/scripts/inject-base-and-fix-paths.js <<'JS'
#!/usr/bin/env node
/**
 * inject-base-and-fix-paths.js
 *
 * Usage: node inject-base-and-fix-paths.js "<BASE_HREF>" <publish_dir>
 *
 * - Rewrites src="/..." and href="/..." (but preserves protocol and // URLs).
 * - Inserts or updates a <base href="..."> tag in HTML <head> if provided.
 */

const fs = require('fs');
const path = require('path');

function walk(dir, fileList = []) {
  const items = fs.readdirSync(dir, { withFileTypes: true });
  for (const it of items) {
    const full = path.join(dir, it.name);
    if (it.isDirectory()) {
      walk(full, fileList);
    } else {
      fileList.push(full);
    }
  }
  return fileList;
}

function fixHtml(filePath, baseHref) {
  let content = fs.readFileSync(filePath, 'utf8');

  // Replace src="/something" or href="/something" but NOT protocol-relative (//) or http(s)://
  content = content.replace(/(href|src)=["']\/(?!\/)([^"'>\s]+)["']/gi, (m, attr, val) => {
    return `${attr}="${val}"`;
  });

  // Insert or update <base href="..."> inside <head>
  if (baseHref && baseHref.length > 0) {
    const baseTag = `<base href="${baseHref}">`;
    if (/<base\s+href=/i.test(content)) {
      content = content.replace(/<base\s+href=["'][^"']*["']\s*\/?>/i, baseTag);
    } else if (/<head[^>]*>/i.test(content)) {
      content = content.replace(/(<head[^>]*>)/i, `$1\n  ${baseTag}`);
    } else {
      content = baseTag + '\n' + content;
    }
  }

  fs.writeFileSync(filePath, content, 'utf8');
  console.log(`Processed: ${filePath}`);
}

/* --- main --- */
(async function main() {
  const args = process.argv.slice(2);
  if (args.length < 2) {
    console.error('Usage: node inject-base-and-fix-paths.js "<BASE_HREF>" <publish_dir>');
    process.exit(2);
  }
  const baseHref = args[0];
  const publishDir = args[1];

  if (!fs.existsSync(publishDir)) {
    console.error('Publish directory not found:', publishDir);
    process.exit(1);
  }

  const allFiles = walk(publishDir);
  const htmlFiles = allFiles.filter(f => f.toLowerCase().endsWith('.html'));

  for (const file of htmlFiles) {
    try {
      fixHtml(file, baseHref);
    } catch (err) {
      console.error('Failed to process', file, err);
    }
  }

  console.log(`Finished processing ${htmlFiles.length} HTML file(s).`);
})();
JS
          chmod +x .github/scripts/inject-base-and-fix-paths.js

      - name: Fix absolute-root paths and inject <base>
        env:
          BASE_HREF: ${{ env.BASE_HREF }}
        run: |
          # runs the helper to remove leading-slash from href/src and inject base href
          node .github/scripts/inject-base-and-fix-paths.js "$BASE_HREF" public

      - name: Preview published files
        run: |
          echo "Files in public (up to 200):"
          find public -type f | sed -n '1,200p' || true
          echo "---- head of public/index.html (if present) ----"
          sed -n '1,120p' public/index.html || true

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: '41898282+github-actions[bot]@users.noreply.github.com'

      - name: Ensure GitHub Pages site is set to the gh-pages branch
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            try {
              await github.rest.repos.createPagesSite({
                owner,
                repo,
                source: { branch: 'gh-pages', path: '/' }
              });
              core.info('Pages site configured to gh-pages branch.');
            } catch (err) {
              core.warning('Could not configure Pages via API (you might not have permissions or it is already configured). ' + err.message);
            }
